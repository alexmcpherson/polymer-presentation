<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymer-core-ajax/core-ajax.html">
<link rel="import" href="../slide-element/slide-element.html">

<polymer-element name="presentation-element" attributes="gist slides">

  <template>
    <core-ajax url="https://api.github.com/gists/{{gist}}?client_id=4a2842df6b2deed903de&client_secret=3f8c81f90b74254512de25a6f0125cec3fbcf629" auto on-core-response="{{handleResponse}}"></core-ajax>
    <link rel="stylesheet" href="presentation-element.css" />
    <h1>A slideshow of: {{description}}</h1>

    <ul>
      <template repeat='{{slide in slides}}'>
        <li><slide-element content='{{slide.content}}' code='{{slide.code}}'></slide-element></li>
      </template>
    </ul>
    <span on-click="{{moveBack}}"><</span>
    <span on-click="{{moveForward}}">></span>
  </template>

  <script>

    Polymer('presentation-element', {
      LookupTable: {
        js: 'javascript'
      },

      handleResponse: function(e, xhr) {
        var gist = JSON.parse(xhr.response);
        var slides = [];

        for (file in gist.files) {
          if (/slide/.test(gist.files[file].filename)) {
            var index = file.split('-')[1].replace(/\.md|\.markdown/, '') - 1;
            slides[index] = slides[index] || {};
            slides[index].content = gist.files[file].content;
          }
          if (/code/.test(gist.files[file].filename)) {
            var index = file.split('-')[1].split('.')[0] - 1;
            var language = file.split('-')[1].split('.')[1];
            slides[index] = slides[index] || {};
            slides[index].code = {
              content: gist.files[file].content,
              language: this.LookupTable[language]
            }
          }
        }
        slides[0].active = true;

        this.slides = slides;
        this.description = gist.description;

        this.fire('slides-loaded');
      },

      moveBack: function() {
        console.log(this.slides, 'back');
      },

      moveForward: function() {
        console.log(this.slides, 'forwards');
      }
    });

  </script>

</polymer-element>
